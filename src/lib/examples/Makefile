all: examples manual-smoke-test

# OMNI_C_ROOT: Root directory of the omni-c project.
# BUILD_DIR:   Directory for build artifacts (absolute path).
ifndef OMNI_C_ROOT
  $(error OMNI_C_ROOT is not defined)
endif

ifndef BUILD_DIR
  $(error BUILD_DIR is not defined)
endif

export ARMYKNIFE_LIB_LOG_LEVEL = WARN

OMNI_CC_PATH := $(BUILD_DIR)/bin/omni-c
LIB_PATH := $(BUILD_DIR)/bin/lib.oar

define build_c_file
	${OMNI_CC_PATH} build \
		--use-statement-parser=true \
		--c-output-file=$(BUILD_DIR)/bin/$(1).c \
		--binary-output-file=$(BUILD_DIR)/bin/$(1) \
		--c-compiler=$(OMNI_C_TEST_COMPILER) \
		$(LIB_PATH) $(1).c
endef

examples:
	$(call build_c_file,unique-file-lines)
	$(call build_c_file,sort-lines)
	$(call build_c_file,line-histogram)
	$(call build_c_file,unique-line-generator)
	$(call build_c_file,code-points)
	$(call build_c_file,terminal-input)

manual-smoke-test: examples
	@echo "================================================================="
	@echo "            unique-file-lines                                    "
	@echo "================================================================="
	$(BUILD_DIR)/bin/unique-file-lines testdata/sample.txt
	@echo "================================================================="
	@echo "            sort-lines                                           "
	@echo "================================================================="
	$(BUILD_DIR)/bin/sort-lines testdata/sample.txt
	@echo "================================================================="
	@echo "            line-histogram                                       "
	@echo "================================================================="
	$(BUILD_DIR)/bin/line-histogram testdata/sample.txt
	@echo "================================================================="
	@echo "            unique-line-generator                                "
	@echo "================================================================="
	$(BUILD_DIR)/bin/unique-line-generator --max-number=1000000 --number-of-lines=5
	@echo "================================================================="
	@echo "            code-points                                          "
	@echo "================================================================="
	cat UTF-8-tests-minus-56.txt | $(BUILD_DIR)/bin/code-points | md5sum
	@echo
	@echo "Should be the same as..."
	@echo
	cat UTF-8-tests-minus-56.txt | iconv -f UTF-8 -t UCS-4 | xxd -p -c 4 | md5sum
	@echo
	@echo "================================================================="
	@echo "            Autogenerated Flags                                  "
	@echo "================================================================="
	$(BUILD_DIR)/bin/unique-file-lines --help || true
	$(BUILD_DIR)/bin/sort-lines --help || true
	$(BUILD_DIR)/bin/line-histogram --help || true
	$(BUILD_DIR)/bin/unique-line-generator --help || true
	$(BUILD_DIR)/bin/code-points --help || true
